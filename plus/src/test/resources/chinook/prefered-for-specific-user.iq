# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
!use CALCITE_AS_SPECIFIC_USER
!set outputformat mysql

# Preferred genres
SELECT * FROM preferred_genres;
+----+
| ID |
+----+
|  1 |
| 15 |
|  2 |
|  7 |
|  9 |
+----+
(5 rows)

!ok

# Preferred albums
SELECT * FROM preferred_albums;
+-----+
| ID  |
+-----+
| 154 |
| 220 |
| 321 |
|   4 |
|  56 |
+-----+
(5 rows)

!ok

# Preferred tracks count by genres
SELECT tr.genreid, COUNT(tr.trackid) as TRACKS_COUNT
FROM chinook.track AS tr
JOIN preferred_genres AS pg ON tr.genreid = pg.id
GROUP BY tr.genreid;
+---------+--------------+
| genreid | TRACKS_COUNT |
+---------+--------------+
|       1 |         1297 |
|      15 |           30 |
|       2 |          130 |
|       7 |          579 |
|       9 |           48 |
+---------+--------------+
(5 rows)

!ok

# should be just like above Preferred tracks count by genres
SELECT tr.genreid, COUNT(tr.trackid) as TRACKS_COUNT
FROM chinook.track AS tr
WHERE tr.genreid IN (SELECT pg.id FROM preferred_genres AS pg)
GROUP BY tr.genreid;
+---------+--------------+
| genreid | TRACKS_COUNT |
+---------+--------------+
|       1 |         1297 |
|      15 |           30 |
|       2 |          130 |
|       7 |          579 |
|       9 |           48 |
+---------+--------------+
(5 rows)

!ok

# Preferred genres
SELECT COUNT(*) AS TRACKS_COUNT FROM preferred_tracks;
+--------------+
| TRACKS_COUNT |
+--------------+
|         2115 |
+--------------+
(1 row)

!ok

# Explain plan for select
EXPLAIN PLAN FOR SELECT * FROM preferred_tracks;
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EnumerableCalc(expr#0..17=[{inputs}], expr#18=[IS NOT NULL($t12)], expr#19=[0], expr#20=[=($t9, $t19)], expr#21=[NOT($t20)], expr#22=[AND($t18, $t21)], expr#23=[CAST($t22):BOOLEAN], expr#24=[IS NOT NULL($t17)], expr#25=[=($t13, $t19)], expr#26=[NOT($t25)], expr#27=[AND($t24, $t26)], expr#28=[CAST($t27):BOOLEAN], expr#29=[OR($t23, $t28)], proj#0..8=[{exprs}], $condition=[$t29])
  EnumerableJoin(condition=[=($15, $16)], joinType=[left])
    EnumerableCalc(expr#0..15=[{inputs}], $f0=[$t2], $f1=[$t3], $f2=[$t4], $f3=[$t5], $f4=[$t6], $f5=[$t7], $f6=[$t8], $f7=[$t9], $f8=[$t10], $f9=[$t11], $f10=[$t12], $f11=[$t13], $f13=[$t15], $f14=[$t0], $f15=[$t1], $f16=[$t4])
      EnumerableJoin(condition=[true], joinType=[inner])
        EnumerableAggregate(group=[{}], agg#0=[COUNT()], agg#1=[COUNT($0)])
          EnumerableTableScan(table=[[ENHANCED, PREFERRED_ALBUMS]])
        EnumerableJoin(condition=[=($11, $12)], joinType=[left])
          EnumerableCalc(expr#0..10=[{inputs}], $f0=[$t2], $f1=[$t3], $f2=[$t4], $f3=[$t5], $f4=[$t6], $f5=[$t7], $f6=[$t8], $f7=[$t9], $f8=[$t10], $f9=[$t0], $f10=[$t1], $f11=[$t6])
            EnumerableJoin(condition=[true], joinType=[inner])
              EnumerableAggregate(group=[{}], agg#0=[COUNT()], agg#1=[COUNT($0)])
                EnumerableTableScan(table=[[ENHANCED, PREFERRED_GENRES]])
              JdbcToEnumerableConverter
                JdbcTableScan(table=[[CHINOOK, TRACK]])
          EnumerableAggregate(group=[{0}], agg#0=[MIN($1)])
            EnumerableCalc(expr#0=[{inputs}], expr#1=[true], proj#0..1=[{exprs}])
              EnumerableTableScan(table=[[ENHANCED, PREFERRED_GENRES]])
    EnumerableAggregate(group=[{0}], agg#0=[MIN($1)])
      EnumerableCalc(expr#0=[{inputs}], expr#1=[true], proj#0..1=[{exprs}])
        EnumerableTableScan(table=[[ENHANCED, PREFERRED_ALBUMS]])
 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
(1 row)

!ok
